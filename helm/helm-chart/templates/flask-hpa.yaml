# Summary: Horizontal Pod Autoscaler (HPA)
# Description:
# Configures autoscaling for the Flask Deployment based on CPU usage.
# The HPA monitors average CPU utilization and adjusts the number of replicas
# to maintain efficient performance and resource usage.

apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ .Values.app.name }}-hpa

spec:
  # Target workload to scale (Flask Deployment)
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ .Values.app.name }}

  # Allowed number of pods managed by the HPA
  minReplicas: 1
  maxReplicas: 3

  # Scale based on average CPU utilization across all pods
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70       # Scale up if average CPU > 70%

  behavior:
    scaleDown:
      # Limit how quickly pods are removed to prevent instability
      stabilizationWindowSeconds: 60
