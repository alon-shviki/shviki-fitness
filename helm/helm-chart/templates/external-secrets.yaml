# Summary: External Secrets for MySQL and Flask Application
# Description:
# This file defines ExternalSecret resources used to sync sensitive values from AWS Secrets Manager
# into Kubernetes Secret objects. It creates two secrets:
# 1. MySQL credentials for the database StatefulSet.
# 2. Application secrets such as the Flask SECRET_KEY and API keys.

# -------------------------------
# 1. MySQL ExternalSecret
# Pulls MySQL credentials from AWS Secrets Manager
# and writes them into a Kubernetes Secret.
# -------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: shviki-mysql-secret
  namespace: {{ .Release.Namespace }}
spec:
  secretStoreRef:
    name: shviki-aws-store
    kind: SecretStore

  target:
    name: {{ .Values.mysql.secretName }}      # Target K8s secret: shviki-mysql-secret
    creationPolicy: Owner

  data:
    - secretKey: MYSQL_ROOT_PASSWORD
      remoteRef:
        key: shviki-fitness/prod/app-secrets
        property: MYSQL_ROOT_PASSWORD

    - secretKey: MYSQL_PASSWORD
      remoteRef:
        key: shviki-fitness/prod/app-secrets
        property: MYSQL_USER_PASSWORD        # AWS key name

    - secretKey: MYSQL_USER
      remoteRef:
        key: shviki-fitness/prod/app-secrets
        property: MYSQL_USER

    - secretKey: MYSQL_DATABASE
      remoteRef:
        key: shviki-fitness/prod/app-secrets
        property: MYSQL_DATABASE

---
# -------------------------------
# 2. Flask Application ExternalSecret
# Syncs application secrets such as SECRET_KEY and API keys
# from AWS Secrets Manager into a Kubernetes Secret.
# -------------------------------
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: shviki-app-secret
  namespace: {{ .Release.Namespace }}
spec:
  secretStoreRef:
    name: shviki-aws-store
    kind: SecretStore

  target:
    name: {{ .Values.app.name }}-secret      # Target K8s secret: shviki-app-secret
    creationPolicy: Owner

  data:
    - secretKey: SECRET_KEY
      remoteRef:
        key: shviki-fitness/prod/app-secrets
        property: FLASK_SECRET_KEY           # AWS key name

    - secretKey: EXERCISE_API_KEY
      remoteRef:
        key: shviki-fitness/prod/app-secrets
        property: RAPIDAPI_KEY               # AWS key name
