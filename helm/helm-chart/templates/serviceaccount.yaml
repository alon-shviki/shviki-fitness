# Summary: ServiceAccount for ShvikiFitness Application
# Description:
# Creates the 'shviki-fitness-sa' ServiceAccount in the app namespace.
# The IRSA IAM Role ARN is loaded dynamically from a ConfigMap written
# by Terraform in the 'argocd' namespace, so no AWS account ID appears
# in the Helm / GitOps repositories.

{{- $cm := lookup "v1" "ConfigMap" "argocd" "shviki-irsa-config" -}}
apiVersion: v1
kind: ServiceAccount
metadata:
  name: shviki-fitness-sa
  namespace: {{ .Release.Namespace }}
  annotations:
    {{- if $cm }}
    eks.amazonaws.com/role-arn: {{ $cm.data.iam_role_arn | quote }}
    {{- else }}
    # IRSA ConfigMap not found. Make sure Terraform applied
    # kubernetes_config_map.shviki_irsa_config before ArgoCD sync.
    eks.amazonaws.com/role-arn: ""
    {{- end }}
